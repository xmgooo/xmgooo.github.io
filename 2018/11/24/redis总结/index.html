<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
<link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">
<style>
    .pace .pace-progress {
        background: #1E92FB; /*进度条颜色*/
        height: 3px;
    }
    .pace .pace-progress-inner {
         box-shadow: 0 0 10px #1E92FB, 0 0 5px     #1E92FB; /*阴影颜色*/
    }
    .pace .pace-activity {
        border-top-color: #1E92FB;    /*上边框颜色*/
        border-left-color: #1E92FB;    /*左边框颜色*/
    }
</style>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/uploads/avatar.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/uploads/avatar.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/uploads/avatar.png?v=5.1.4">






  <meta name="keywords" content="redis,缓存,">





  <link rel="alternate" href="/atom.xml" title="xmgooo" type="application/atom+xml">






<meta name="description" content="关于redis的一点总结 引言&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;常规的应用系统的系统瓶颈大部分都出现在数据库的IO操作，并且90%的请求基本都是select操作，对于数据库的优化手段可以有非常多的手段，举几种常见的:">
<meta name="keywords" content="redis,缓存">
<meta property="og:type" content="article">
<meta property="og:title" content="redis总结">
<meta property="og:url" content="http://yoursite.com/2018/11/24/redis总结/index.html">
<meta property="og:site_name" content="xmgooo">
<meta property="og:description" content="关于redis的一点总结 引言&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;常规的应用系统的系统瓶颈大部分都出现在数据库的IO操作，并且90%的请求基本都是select操作，对于数据库的优化手段可以有非常多的手段，举几种常见的:">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://yoursite.com/2018/11/24/redis总结/单节点.jpg">
<meta property="og:image" content="http://yoursite.com/2018/11/24/redis总结/slave节点分担读压力.jpg">
<meta property="og:image" content="http://yoursite.com/2018/11/24/redis总结/加入哨兵.jpg">
<meta property="og:image" content="http://yoursite.com/2018/11/24/redis总结/2x版本实现分片.jpg">
<meta property="og:image" content="http://yoursite.com/2018/11/24/redis总结/3x版本集群.jpg">
<meta property="og:image" content="http://yoursite.com/2018/11/24/redis总结/clusterinfo.jpg">
<meta property="og:image" content="http://yoursite.com/2018/11/24/redis总结/停掉7004主节点后.jpg">
<meta property="og:image" content="http://yoursite.com/2018/11/24/redis总结/日志显示切换成功.jpg">
<meta property="og:image" content="http://yoursite.com/2018/11/24/redis总结/重启7004后.jpg">
<meta property="og:image" content="http://yoursite.com/2018/11/24/redis总结/恢复日志.jpg">
<meta property="og:updated_time" content="2018-11-25T12:44:57.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="redis总结">
<meta name="twitter:description" content="关于redis的一点总结 引言&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;常规的应用系统的系统瓶颈大部分都出现在数据库的IO操作，并且90%的请求基本都是select操作，对于数据库的优化手段可以有非常多的手段，举几种常见的:">
<meta name="twitter:image" content="http://yoursite.com/2018/11/24/redis总结/单节点.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/11/24/redis总结/">





  <title>redis总结 | xmgooo</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-right page-post-detail">
    <div class="headband"></div>

    <a href="https://github.com/xmgooo" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewbox="0 0 250 250" style="fill:#64CEAA; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">xmgooo</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">take it easy</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            日志
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/24/redis总结/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="xiemao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xmgooo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">redis总结</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-24T12:43:29+08:00">
                2018-11-24
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/11/24/redis总结/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2018/11/24/redis总结/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  11k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  43
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="关于redis的一点总结"><a href="#关于redis的一点总结" class="headerlink" title="关于redis的一点总结"></a>关于redis的一点总结</h1><hr>
<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;常规的应用系统的系统瓶颈大部分都出现在数据库的IO操作，并且90%的请求基本都是select操作，对于数据库的优化手段可以有非常多的手段，举几种常见的:<br><a id="more"></a><br>1.最基本的数据库表结构设计优化，理论上的三大范式，表结构结合业务设计的合理性，是否可从业务角度优化，如两次查询变为一次查询，联表查变为单表操作，跨库操作是否可以避免或者优化，sql语句的优化等。<br>2.索引，代价最小，实现难度最低，效果提升显著，但要考虑索引维护带来的性能开销，对于一些批量更新或者集中的update，delete操作，可以考虑动态索引，即在开启操作前删除索引，执行完后再添加上索引。<br>3.mysql参数的优化，连接数，缓冲池大小等。<br>4.读写分离，扩展slave节点，分担读请求的压力，但要注意数据同步操作可能带来的延迟性问题。<br>5.大表拆分，这里可分为水平和垂直两个方向。水平拆分，分表，减少单表数据量过大的问题，一般mysql单表数据控制在1000w性能最优，注意拆分业务的合理性，常用的可以有主键hash，业务字段取余（如日期，订单），但要提前规划好容量。垂直拆分，1次查询变为两次关联，冷热数据字段分离等。<br>6.分库，应对单库性能瓶颈的一种手段，但要注意可能带来的跨库操作，或者复杂查询（count，group by，top）等增加的复杂性。<br>7.缓存。</p>
<h2 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;关于缓存，缓存分为很多种，页面缓存cookie，基于会话，session的临时缓存springcache，hibernate，mybatis等，基于内存的redis/memcached等缓存，常用的redis和memcached，memcached没研究过，不过多说了，网上对比的资料也很多，感觉能用memcached的地方都能用redis代替，并且memcached不支持持久化操作和事务，这点限定了它的很多使用场景，至于它的在小数据量下相比于redis的性能优点，redis通过集群的手段也能有所弥补，本身已经够快了，那点速度的差别也微不足道了。在请求量特别大的时候，可以考虑二级缓存，一级缓存通过springcache在进程内缓存一个userid+ip+时间戳等，过滤重复请求或者业务处理，不过这种缓存是存在某一台应用服务器的，可能需要将ng等负载均衡服务器的策略改为定向转发而不是轮询等，二级缓存再考虑redis等。</p>
<h2 id="redis特点"><a href="#redis特点" class="headerlink" title="redis特点"></a>redis特点</h2><p>1.非关系型数据库（数据模型简单）<br>2.基于内存，基于内存优于基于磁盘本身的特色(ps个笑话：因为内存距离cpu的距离比硬盘更近，所以性能好:) ,读写能力高，Redis能读的速度可达110000次/s,写的速度是81000次/s，具体可参考官网。<br>3.单线程，和多线程相比的优势，避免的线程的上下文切换和锁竞争问题，加锁释放锁等资源消耗，死锁等一系列问题都可以被屏蔽掉，单线程的特色决定了cpu本身就不可能成为性能瓶颈，但是在应对多核cpu的处理器，单线程就可能显的比较鸡肋和奢侈了，这种的应对办法一般是在单机上部署多个redis实例，比如8核的cpu，理论上可以部署8个redis实例，但是这也只是想象的，因为本身redis的持久化操作和数据同步等操作都会开启临时子线程去处理，如果部署太多实例，实例间的通信和同步带来的开销可能反而会使性能降低，所以需综合cpu的实际情况进行考量，真正决定redis性能的在于实际内存大小和网络io。网络io分为客户端的请求io和节点间同步或通信的io，客户端请求io操作优化方向无非两点，次数和大小，批量批量提交，较少io次数，序列化请求数据，protobuf，kyro等，节点间同步或通信io操作建议只在slave节点aof持久化操作，master节点不进行持久化，master节点的持久化操作可能带来写入性能的不稳定。对于节点间的同步io消耗，如果将master和slave部署在同一台机器上，确实会极大的降低io，但是不建议这么做，还是建议采取交叉部署的方式，将同一个分区的master和slave分散在不同机器。  关于内存的使用，建议不要让你的 Redis 所在机器物理内存使用超过实际内存总量的3/5，详细分析可以参考下<a href="https://mp.weixin.qq.com/s/5TtTplThal2otR8xJB6OEw" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/5TtTplThal2otR8xJB6OEw</a></p>
<h2 id="持久化操作：rdb和aof"><a href="#持久化操作：rdb和aof" class="headerlink" title="持久化操作：rdb和aof"></a>持久化操作：rdb和aof</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rbd：周期性的刷盘，相当于linux中的快照概念，所以也被称为快照持久化，如每一秒定时将内存中的数据写入硬盘中，不适用于实时的系统，如想保证数据的高可用性，即最大限度的避免数据丢失，那么RDB将不是一个很好的选择。因为系统一旦在定时持久化之前出现宕机现象，此前没有来得及写入磁盘的数据都将丢失。save命令和bgsave命令都可以生成RDB文件，线上环境应该禁掉save命令，这是个同步操作，会阻塞主进程，而bgsave命令会创建一个子进程，由子进程来负责创建RDB文件，父进程(即Redis主进程)则继续处理请求。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;aof：类似于mysql的binlog，和oracle中的undo，实时将每次执行的写命令保存到硬盘，宕机或者掉电后数据可恢复，但实时的日志会带来额外的性能开销。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;两种方式的取舍主要是在持久化的性能和一致性之间做取舍。<br>给出自己的一点理解吧：<br>1.晚上执行定时任务跑批量或者缓存更新备份或者数据恢复的时候会用rdb，跑批失败了可以恢复到跑批前的快照，重新执行定时任务或者重新备份即可。<br>2.并发量不大情况下，对数据完整性要求较高时，可启用aof。 aof应该<br>3.若只打算用Redis 做缓存，可以关闭持久化，仅靠master／salve replication实现高可用也行，能节省一大笔io,代价是如果master／salve同时宕机（此时建议采用交叉部署，master部署在a机房，slave1部署在b机房，slave2部署在c机房，虽然跨机房的部署同步会增加io，但相比于aof的io就显得微不足道了，这种可以将一个集群同时宕机的风险降到最低，只要一个节点活着，数据即是完整，除非你说北京，上海，广州的机房同时炸了。）<br>4.关于rdb和aof更多详情信息，可以参考下这篇<a href="https://mp.weixin.qq.com/s/XmFygIm5zuR8ni5ak91-uQ" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/XmFygIm5zuR8ni5ak91-uQ</a></p>
<h2 id="版本比较"><a href="#版本比较" class="headerlink" title="版本比较"></a>版本比较</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2.6版本推出了哨兵的机制，但是特别不稳定，各种各样的bug，2.8版本这个功能才算稳定下来，2.x哨兵的作用是一是监控主从，定时的心跳检测包看集群是否健康，二是实现切换，master宕机后通过选举算法在此master下的slave中找一个顶上来。可以配置多个master做高可用，master与master实现复制同步。即使使用哨兵，redis每个实例也是全量存储，每个redis存储的内容都是完整的数据，浪费内存，单点容量上限无法突破。这里比较知名的企业或者组织就衍生开源了一系列方案，为了做数据分片，大致两种思路，分为客户端分片和服务端分片，客户端分片通过代码在客户端实现，但是存在可扩展性差，不能跨语言，不通用等问题，服务端分片都是加一层proxy代理层集群加zk来做的，通过proxy代理层重定向到各个集群分片，实现难度较大，增加了系统复杂度（一个很坑和很冷的笑话：没有什么架构问题是向上加一层不能解决的，如果不能，那就加两层）<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3.x版本较2.x版本的master/slave+哨兵的架构上有了很大扩展，抛弃了之前的架构，基于分片进行存储，采用hash进行分区映射，解决了以前master/slave+哨兵模式中的内存/QPS受限于单机的困境，即每台master redis存储不同的内容，master节点上具备slot槽的概念，存储写入时通过hash确定写入到哪个节点，读取时也是先确定数据在哪个槽上，再找到对应的节点，之后在本机上进行读取，这里要说明下，每个master节点下可挂载多个slave节点，slave节点本身是不具备槽的。有时为了解决master下挂载过多slave数据同步带来的延迟问题，可能会采用master下只挂在一个slave1，slave1下再挂在slave2，slave2下再挂在slave3这种串行的架构，这种模式其实我没明白，如果slave1断开的话，后面的一串跟master怎么通信（有待考核）<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;集群的这种架构去中心化，内联通信，本身master节点又可以存储数据，又可以与其它master进行通信，可用于大数据量高可用Cache/存储等场景。这种内联的架构感觉更符合现代互联网的架构模式，将监控与应用结合在一起，每个节点即是执行者也是监督者，节点之间互相通信，底层实现的话目前还不太清楚，节点之间的依赖问题，通信带来的延迟问题感觉会有特殊的处理手段，目前想不到怎么做的<br>两种不同的代表：Elasticsearch类比3.x和dubbo+zk类比2.x。 </p>
<h2 id="架构演进图"><a href="#架构演进图" class="headerlink" title="架构演进图"></a>架构演进图</h2><p><img src="/2018/11/24/redis总结/单节点.jpg" alt="1.jpg"><center>单节点</center><br><img src="/2018/11/24/redis总结/slave节点分担读压力.jpg" alt="1.jpg"><center>slave节点分担读压力</center><br><img src="/2018/11/24/redis总结/加入哨兵.jpg" alt="1.jpg"><center>2.6版本后加入哨兵集群，实现主从切换</center><br><img src="/2018/11/24/redis总结/2x版本实现分片.jpg" alt="1.jpg"><center>2.x版本通过proxy实现分片存储，减少master写压力</center><br><img src="/2018/11/24/redis总结/3x版本集群.jpg" alt="1.jpg"><center>3x版本集群</center>  </p>
<h2 id="单实例安装"><a href="#单实例安装" class="headerlink" title="单实例安装"></a>单实例安装</h2><p>下载地址<a href="http://redis.io/download安装步骤：" target="_blank" rel="noopener">http://redis.io/download安装步骤：</a><br>1 首先需要安装gcc，把下载好的redis-3.0.0-rc2.tar.gz 放到linux /usr/local文件夹下<br>2 进行解压 tar -zxvf redis-3.0.0-rc2.tar.gz<br>3 进入到redis-3.0.0目录下，进行编译 make<br>4 进入到src下进行安装 make install  验证(ll查看src下的目录，有redis-server 、redis-cil即可)<br>5 建立俩个文件夹存放redis命令和配置文件<br>mkdir -p /usr/local/redis/etc<br>mkdir -p /usr/local/redis/bin<br>6 把redis-3.0.0下的redis.conf 移动到/usr/local/redis/etc下，<br>   cp redis.conf /usr/local/redis/etc/<br>7 把redis-3.0.0/src里的mkreleasehdr.sh、redis-benchmark、redis-check-aof、redis-check-dump、redis-cli、redis-server<br>文件移动到bin下，命令：<br>mv mkreleasehdr.sh redis-benchmark redis-check-aof redis-check-dump redis-cli redis-server /usr/local/redis/bin<br>8 启动时并指定配置文件：<br>/usr/local/redis/bin/redis-server /usr/local/redis/etc/redis.conf（注意要使用后台启动，所以修改redis.conf里的 daemonize 改为yes)<br>9 验证启动是否成功： ps -ef | grep redis 查看是否有redis服务 或者 查看端口：netstat -tunpl | grep 6379<br>进入redis客户端 ./redis-cli 退出客户端quit<br>退出redis服务：<br>（1）pkill redis-server 、<br>（2）kill 进程号、<br>（3）/usr/local/redis/bin/redis-cli shutdown  </p>
<h2 id="哨兵模式的安装"><a href="#哨兵模式的安装" class="headerlink" title="哨兵模式的安装"></a>哨兵模式的安装</h2><p>（1）copy文件sentinel.conf到usr/local/redis/etc中<br> (2) 修改sentinel.conf文件:<br>  sentinel monitor mymaster 192.168.1.174 6379 1 #名称，ip，端口，投票选举次数<br>  sentinel down-after-milliseconds mymaster 5000 #默认1s检测一次，这里配置超时5000毫秒为宕机<br>  sentinel failover-timeout mymaster 9000000<br>  sentinel can-failover mymaster yes<br>  sentinel parallel-syncs mymaster 2<br>  (3) 启动sentinel哨兵<br>  /usr/local/redis/bin/redis-server /usr/local/redis/etc/sentinel.conf –sentinel &amp;<br>  (4) 查看哨兵相关信息命令<br>  /usr/local/redis/bin/redis-cli -h 192.168.1.175 -p 26379 info sentinel<br>  (5) 关闭主服务器<br>  /usr/local/redis/bin/redis-cli -h 192.168.1.175 -p 6379 shutdown</p>
<h2 id="Redis-3-0-集群搭建"><a href="#Redis-3-0-集群搭建" class="headerlink" title="Redis 3.0 集群搭建"></a>Redis 3.0 集群搭建</h2><p>/<strong><strong><strong><strong><strong>*</strong></strong></strong></strong></strong> Redis 3.0 集群搭建 <strong><strong><strong><strong><strong><strong><strong><em>**</em></strong></strong></strong></strong></strong></strong></strong>/<br>在redis3.0以前，提供了Sentinel工具来监控各Master的状态;<br>如果Master异常，则会做主从切换，将slave作为master，将master作为slave。<br>其配置也是稍微的复杂，并且各方面表现一般。现在redis3.0已经支持集群的容错功能，并且非常简单。<br>下面我们来进行学习下redis3.0如何搭建集群（集群搭建：至少要三个master）。<br>第一步：创建一个文件夹redis-cluster，然后在其下面分别创建6个文件夹如下：<br>（1）mkdir -p /usr/local/redis-cluster<br>（2）mkdir 7001、mkdir 7002、mkdir 7003、mkdir 7004、mkdir 7005、mkdir 7006</p>
<p>第二步：把之前的redis.conf配置文件分别copy到700<em>下，进行修改各个文件内容，也就是对700</em>下的每一个copy的redis.conf文件进行修改！如下：（1）daemonize yes<br>（2）port 700<em>（分别对每个机器的端口号进行设置）<br>（3）bind 192.168.1.171（必须要绑定当前机器的ip，不然会无限悲剧下去哇..深坑勿入！！！）<br>（4）dir /usr/local/redis-cluster/700</em>/（指定数据文件存放位置，必须要指定不同的目录位置，不然会丢失数据，深坑勿入！！！）<br>（5）cluster-enabled yes（启动集群模式，开始玩耍）<br>（6）cluster-config-file nodes700*.conf（这里700x最好和port对应上）<br>（7）cluster-node-timeout 5000<br>（8）append only yes<br>数据文件dump.rdb放入到etc目录下</p>
<p>第三步：注意每个文件要修改端口号，bind的ip，数据存放的dir，并且nodes文件都需要进行修改！</p>
<p>第四步：由于redis集群需要使用ruby命令，所以我们需要安装ruby<br>（1）yum install ruby<br>（2）yum install rubygems<br>（3）gem install redis （安装redis和ruby的接口）</p>
<p>第五步：分别启动6个redis实例，然后检查是否启动成功<br>（1）/usr/local/redis/bin/redis-server /usr/local/redis-cluster/700*/redis.conf<br>（2）ps -el | grep redis 查看是否启动成功</p>
<p>第六步：首先到redis3.0的安装目录下，然后执行redis-trib.rb命令。<br>（1）cd /usr/local/redis3.0/src<br>（2）./redis-trib.rb  create –replicas 1 10.211.55.6:7001 10.211.55.6:7002 10.211.55.6:7003 10.211.55.6:7004 10.211.55.6:7005 10.211.55.6:7006</p>
<p>第七步：到此为止我们集群搭建成功！进行验证：<br>（1）连接任意一个客户端即可：./redis-cli -c -h -p （-c表示集群模式，指定ip地址和端口号）如：/usr/local/redis/bin/redis-cli -c -h 10.211.55.6 -p 7001<br>（2）进行验证：cluster info（查看集群信息）、cluster nodes（查看节点列表）<br><img src="/2018/11/24/redis总结/clusterinfo.jpg" alt="1.jpg">上图集群节点信息说明一下，从左到右分别为<id> <a href="ip:port" target="_blank" rel="noopener">ip:port</a> <flags> <master> <ping-sent> <pong-recv> <config-epoch> <link-state> <slot> <slot> … <slot><br>    1.id: 节点ID,是一个40字节的随机字符串，这个值在节点启动的时候创建，并且永远不会改变（除非使用CLUSTER RESET HARD命令）。<br>    2.ip:port: 客户端与节点通信使用的地址.<br>    3.flags: 逗号分割的标记位，可能的值有: myself, master, slave, fail?, fail, handshake, noaddr, noflags. 下一部分将详细介绍这些标记.<br>    4.master: 如果节点是slave，并且已知master节点，则这里列出master节点ID,否则的话这里列出”-“。<br>    5.ping-sent: 最近一次发送ping的时间，这个时间是一个unix毫秒时间戳，0代表没有发送过.<br>    6.pong-recv: 最近一次收到pong的时间，使用unix时间戳表示.<br>    7.config-epoch: 节点的epoch值（or of the current master if the node is a slave）。每当节点发生失败切换时，都会创建一个新的，独特的，递增的epoch。如果多个节点竞争同一个哈希槽时，epoch值更高的节点会抢夺到。<br>    8.link-state: node-to-node集群总线使用的链接的状态，我们使用这个链接与集群中其他节点进行通信.值可以是 connected 和 disconnected.<br>    9.slot: 哈希槽值或者一个哈希槽范围. 从第9个参数开始，后面最多可能有16384个 数(limit never reached)。代表当前节点可以提供服务的所有哈希槽值。如果只是一个值,那就是只有一个槽会被使用。如果是一个范围，这个值表示为起始槽-结束槽，节点将处理包括起始槽和结束槽在内的所有哈希槽。<br>  各flags的含义 (上面所说数据项3):<br>myself: 当前连接的节点.<br>master: 节点是master.<br>slave: 节点是slave.<br>fail?: 节点处于PFAIL 状态。 当前节点无法联系，但逻辑上是可达的 (非 FAIL 状态).<br>fail: 节点处于FAIL 状态. 大部分节点都无法与其取得联系将会将改节点由 PFAIL 状态升级至FAIL状态。<br>handshake: 还未取得信任的节点，当前正在与其进行握手.<br>noaddr: 没有地址的节点（No address known for this node）.<br>noflags: 连个标记都没有（No flags at all）.<br>因为这里没有借助第三方插件的管控台，所以看懂节点的状态信息还是非常重要的，结合日志文件的说明可以更加清楚此时节点的健康状态<br>（3）进行数据操作验证<br>（4）关闭集群则需要逐个进行关闭，试验一下主从切换，此时7004为一个master节点，使用命令：/usr/local/redis/bin/redis-cli -c -h 10.211.55.6 -p 7004  shutdown<br><img src="/2018/11/24/redis总结/停掉7004主节点后.jpg" alt="1.jpg"> 停掉7004主节点后：注意一下变化7004目前时fail状态，原本是slave的7001此时变为了master，原本7004之上的slot 66-5460移动到了7001，下面是切换的日志</slot></slot></slot></link-state></config-epoch></pong-recv></ping-sent></master></flags></id></p>
<p><img src="/2018/11/24/redis总结/日志显示切换成功.jpg" alt="1.jpg"><br>重启7004后，7004重新以slave节点的状态加入集群，并被挂载到7001主节点下，同时开启子线程恢复宕机期间的数据,看下图cluster nodes和日志输出<br><img src="/2018/11/24/redis总结/重启7004后.jpg" alt="1.jpg"><br><img src="/2018/11/24/redis总结/恢复日志.jpg" alt="1.jpg"><br>第八步：（补充）<br>友情提示：当出现集群无法启动时，删除临时的数据文件，再次重新启动每一个redis服务，然后重新构造集群环境。</p>
<p>第九步：（集群操作文章）<br>redis-trib.rb官方群操作命令: <a href="http://redis.io/topics/cluster-tutorial" target="_blank" rel="noopener">http://redis.io/topics/cluster-tutorial</a><br>推荐博客: <a href="http://blog.51yip.com/nosql/1726.html/comment-page-1" target="_blank" rel="noopener">http://blog.51yip.com/nosql/1726.html/comment-page-1</a></p>
<h2 id="I-O-多路复用"><a href="#I-O-多路复用" class="headerlink" title="I/O 多路复用"></a>I/O 多路复用</h2><p>  异步  类型于nginx的epoll 负载均衡的实现。核心的理念了，不充分了解的话感觉对redis还是只停留在应用层面，目前还不是很懂，可以参考下<a href="https://blog.csdn.net/happy_wu/article/details/80052617" target="_blank" rel="noopener">https://blog.csdn.net/happy_wu/article/details/80052617</a></p>
<h2 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h2><p>在Redis采用了线程封闭的方式，把任务封闭在一个线程，自然避免了线程安全问题，不过对于需要依赖多个redis操作的复合操作来说，依然可能需要事务,它是是一组命令的集合。<br>Redis事务的实现需要用到 MULTI 和 EXEC 两个命令，事务开始的时候先向Redis服务器发送 MULTI 命令，然后依次发送需要在本次事务中处理的命令，最后再发送 EXEC 命令表示事务命令结束</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">    &lt;property name=&quot;enableTransactionSupport&quot; value=&quot;true&quot;&gt;</span><br><span class="line"></span><br><span class="line">    public void useTransaction(boolean use) &#123;</span><br><span class="line">        redisTemplate.setEnableTransactionSupport(use);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 开启事务   一个begin只能对应一个commit或者rollback，用完即销毁</span><br><span class="line">     */</span><br><span class="line">    public void beginTransaction() &#123;</span><br><span class="line">        redisTemplate.multi();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 同在管控台操作不通，管控台开启multi，数据进入QUEUED阶段，必须执行exec才会刷盘成功</span><br><span class="line">     * 客户端连接时，不进行exec，会默认提交所有开启multi的数据</span><br><span class="line">     */</span><br><span class="line">    public void commit() &#123;</span><br><span class="line">        redisTemplate.exec();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void rollback() &#123;</span><br><span class="line">        redisTemplate.discard();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 在finally中记得释放资源，不要执行redisTemplate.exec();</span><br><span class="line">     * 如果事务异常进入catch中，catch中的discard会消耗掉multi，此时exec会找不到对应的multi，报错，事务失败</span><br><span class="line">     */</span><br><span class="line">    public void close() &#123;</span><br><span class="line">//        redisTemplate.exec();</span><br><span class="line">        RedisConnectionUtils.unbindConnection(redisTemplate.getConnectionFactory());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>test：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public void test() &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            redisUtil.useTransaction(true);</span><br><span class="line"></span><br><span class="line">            redisUtil.beginTransaction();</span><br><span class="line">            redisUtil.set(&quot;name1&quot;, &quot;xiemao1111&quot;);</span><br><span class="line">//            redisUtil.commit();</span><br><span class="line">//            int a = 1 / 0;</span><br><span class="line">            redisUtil.set(&quot;name2&quot;, &quot;xiemao2222&quot;);</span><br><span class="line">            redisUtil.commit();</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            redisUtil.rollback();</span><br><span class="line">            logger.error(&quot;error:&quot;,e);</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            redisUtil.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="缓存淘汰策略："><a href="#缓存淘汰策略：" class="headerlink" title="缓存淘汰策略："></a>缓存淘汰策略：</h2><p>redis.conf中的 maxmemory-policy volatile-lru<br>1）noeviction：当内存不足以容纳新写入数据时，新写入操作会报错。应该没人用吧。<br>2）allkeys-lru：当内存不足以容纳新写入数据时，在键空间中，移除最近最少使用的key。推荐使用。<br>3）allkeys-random：当内存不足以容纳新写入数据时，在键空间中，随机移除某个key。应该也没人用吧，你不删最少使用Key,去随机删。<br>4）volatile-lru：当内存不足以容纳新写入数据时，在设置了过期时间的键空间中，移除最近最少使用的key。这种情况一般是把redis既当缓存，又做持久化存储的时候才用。不推荐。<br>5）volatile-random：当内存不足以容纳新写入数据时，在设置了过期时间的键空间中，随机移除某个key。依然不推荐。<br>6）volatile-ttl：当内存不足以容纳新写入数据时，在设置了过期时间的键空间中，有更早过期时间的key优先移除。不推荐。</p>
<h2 id="实际应用场景，自己的一点体会："><a href="#实际应用场景，自己的一点体会：" class="headerlink" title="实际应用场景，自己的一点体会："></a>实际应用场景，自己的一点体会：</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1.应用服务器做到无状态：session存储在redis中，做单点登录的时候，就是用hash存储用户信息，以cookieId作为key，设置30分钟为缓存过期时间，能很好的模拟出类似session的效果。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2.mysql数据的缓存，接口数据的缓存，最常用也最为常见的功能，有各种各样的选择方式，举两个例子，一种是以mysql的某个字段或者几个字段组合项作为key，对应的数据列存个json，这种是以mysql的为基准来进行缓存的，对于查询service这种天然幂等性的接口，service里面包含了a＋b＋c等n个查询，这种就不建议缓存各个查询条件和结果了，直接service方法的全路径名加＋请求参数拼接的字符串作为key，返回值作为value，走到这个服务的代码如果入参相同，直接走缓存，服务下面的逻辑跳过，service服务等包含更新操作，说到幂等性，对于分布式场景，接口一方面要提供超时机制，一方面要保证接口的可重入性，也就是保证接口的幂等性，可以通过mysql的唯一索引重复插入抛出异常进行回滚控制，也可以借助redis生成唯一标示，标示接口被调用过，防止超时后的重复请求问题。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3.消息队列，不建议，毕竟不是专业的，数据不丢失（虽然有事务机制，但做到像mq那样保证生产者的事务回滚机制，消费者的去阻塞堆积的功能，广播消息的实现还是比较复杂的）业务数据有专业的mq，流式数据有kafka等，没必要用redis。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.全局唯一标志，订单号，流水号等需唯一的数据，redis可充当发号器的角色，如在代码中生成一个订单号，保证全局唯一,这时可用redis的setnx，前缀为业务标示加上用户id，如”xxxdb”+”uid”+当前时间戳通过setnx操作，返回值进行判断，如果为1，让入成功，不为1，让入失败，while循环着。记得设置一天的过期时间。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5.全局的数据，全局的单例模式的概念只是在当前jvm下的单例，生成分布式环境下唯一资源对象或者是对统一资源进行并发的修改更新操作等，如创建一个如秒杀商品扣库存等操作。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">long num = get count;</span><br><span class="line">if(num&lt;1)&#123;</span><br><span class="line">	logger.error(&quot;库存不足&quot;);</span><br><span class="line">	return;</span><br><span class="line">&#125;</span><br><span class="line">long result = decr count;</span><br><span class="line">if(result &gt;=0)&#123;</span><br><span class="line">	//sucs,mysql扣库存</span><br><span class="line">&#125;else&#123;</span><br><span class="line">	result = incr result;//购买失败,redis补偿</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6.分布式锁，实现方式很多种，如：<br> (1)数据库的版本号，加个version字段用乐观锁的方式。<br> (2)zk的临时节点，进来的时候判断下有没有临时节点，没有创建一个获得执行权，执行完删除临时节点，有的话说明资源被抢占，阻塞等待。<br> (3)redis实现分布式锁，其实有各种各样的方式，我目前理解的好像还没有绝对安全的方式，但是有几种比较典型的错误方式如破坏setnx的原子性操作，客户端时钟与服务器时钟不同步的问题，集群的子线程io异步同步数据在不稳定的情况下可能导致的重复锁的等等问题，可以参考下<a href="https://mp.weixin.qq.com/s/8FYMUpaBcgOZ9lEqt-0PKg" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/8FYMUpaBcgOZ9lEqt-0PKg</a> 这篇文章，写得还可以，对于java两种客户端jedis和stringRedisTemplate，我之前一直都是这么使用的：<br> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public static boolean tryGetDistributedLock(Jedis jedis, String lockKey, String requestId, int expireTime) &#123;</span><br><span class="line">        String result = jedis.set(lockKey, requestId, SET_IF_NOT_EXIST, SET_WITH_EXPIRE_TIME, expireTime);</span><br><span class="line">        if (LOCK_SUCCESS.equals(result)) &#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>释放锁应该在finally里面进行释放，避免代码异常索得不到释放<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">stringRedisTemplate.opsForValue().setIfAbsent(redisKey, startTime.toString());</span><br><span class="line">stringRedisTemplate.delete(redisKey);</span><br></pre></td></tr></table></figure></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7.缓存时间的设置，缓存雪崩：即缓存同一时间大面积的失效，这个时候又来了一波请求，结果请求都怼到数据库上，从而导致数据库连接异常<br>处理：<br>参考方案一：一个批量操作，设置expire time时，在expire time的基础上给缓存的失效时间加上一个随机值（1到5分钟），避免集体失效。<br>参考方案二：双缓存。我们有两个缓存，缓存A和缓存B。缓存A的失效时间为20分钟，缓存B不设失效时间。自己做缓存预热操作。然后细分以下几个小点：<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;I 从缓存A读数据库，有则直接返回<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;II A没有数据，直接从B读数据，直接返回，并且异步启动一个更新线程。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;III 更新线程同时更新缓存A和缓存B。<br>还是推荐1吧，2需要维护两份缓存，麻烦<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;8.缓存穿透<br> （1）布隆过滤器：将所有可能存在的数据哈希到一个足够大的bitmap中，一个一定不存在的数据会被这个bitmap拦截掉，从而避免了对底层存储系统的查询压力<br>   （2）如果一个查询返回的数据为空（不管是数据不存在，还是系统故障），我们仍然把这个空结果进行缓存，但它的过期时间会很短，最长不超过五分钟</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;9.在cluster模式下，对mset  mget命令限制很多，要求批量设置的key 都在同一台redis实例上，否则报异常<br>    解决：不建议用mset等，用hashmap转为json存储，hashmap中的元素增加变为json的覆盖。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10.绝大多数命令的时间复杂度都为O(1) ,对于keys * 这样n时间复杂度的操作在生产环境也应该被禁止掉，执行这一的操作因数据的大小而时间不可控，会造成线程的阻塞，大量请求被堆积。 </p>
<h2 id="配置文件参考："><a href="#配置文件参考：" class="headerlink" title="配置文件参考："></a>配置文件参考：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br></pre></td><td class="code"><pre><span class="line"># Redis 配置文件</span><br><span class="line"></span><br><span class="line"># 当配置中需要配置内存大小时，可以使用 1k, 5GB, 4M 等类似的格式，其转换方式如下(不区分大小写)</span><br><span class="line">#</span><br><span class="line"># 1k =&gt;</span><br><span class="line">1000 bytes</span><br><span class="line"># 1kb =&gt; 1024 bytes</span><br><span class="line"># 1m =&gt; 1000000 bytes</span><br><span class="line"># 1mb =&gt;</span><br><span class="line">1024*1024 bytes</span><br><span class="line"># 1g =&gt; 1000000000 bytes</span><br><span class="line"># 1gb =&gt; 1024*1024*1024</span><br><span class="line">bytes</span><br><span class="line">#</span><br><span class="line"># 内存配置大小写是一样的.比如 1gb 1Gb 1GB 1gB</span><br><span class="line"></span><br><span class="line"># daemonize no 默认情况下，redis不是在后台运行的，如果需要在后台运行，把该项的值更改为yes</span><br><span class="line">daemonize</span><br><span class="line">yes</span><br><span class="line"></span><br><span class="line"># 当redis在后台运行的时候，Redis默认会把pid文件放在/var/run/redis.pid，你可以配置到其他地址。</span><br><span class="line">#</span><br><span class="line">当运行多个redis服务时，需要指定不同的pid文件和端口</span><br><span class="line">pidfile /var/run/redis.pid</span><br><span class="line"></span><br><span class="line"># 指定redis运行的端口，默认是6379</span><br><span class="line">port 6379</span><br><span class="line"></span><br><span class="line"># 指定redis只接收来自于该IP地址的请求，如果不进行设置，那么将处理所有请求，</span><br><span class="line"># 在生产环境中最好设置该项</span><br><span class="line"># bind</span><br><span class="line">127.0.0.1</span><br><span class="line"></span><br><span class="line"># Specify the path for the unix socket that will be used to listen for</span><br><span class="line">#</span><br><span class="line">incoming connections. There is no default, so Redis will not listen</span><br><span class="line"># on a</span><br><span class="line">unix socket when not specified.</span><br><span class="line">#</span><br><span class="line"># unixsocket /tmp/redis.sock</span><br><span class="line">#</span><br><span class="line">unixsocketperm 755</span><br><span class="line"></span><br><span class="line"># 设置客户端连接时的超时时间，单位为秒。当客户端在这段时间内没有发出任何指令，那么关闭该连接</span><br><span class="line"># 0是关闭此设置</span><br><span class="line">timeout</span><br><span class="line">0</span><br><span class="line"></span><br><span class="line"># 指定日志记录级别</span><br><span class="line"># Redis总共支持四个级别：debug、verbose、notice、warning，默认为verbose</span><br><span class="line">#</span><br><span class="line">debug  记录很多信息，用于开发和测试</span><br><span class="line"># varbose 有用的信息，不像debug会记录那么多</span><br><span class="line">#</span><br><span class="line">notice 普通的verbose，常用于生产环境</span><br><span class="line"># warning 只有非常重要或者严重的信息会记录到日志</span><br><span class="line">loglevel</span><br><span class="line">debug</span><br><span class="line"></span><br><span class="line"># 配置log文件地址</span><br><span class="line"># 默认值为stdout，标准输出，若后台模式会输出到/dev/null</span><br><span class="line">#logfile</span><br><span class="line">stdout</span><br><span class="line">logfile /var/log/redis/redis.log</span><br><span class="line"></span><br><span class="line"># To enable logging to the system logger, just set &apos;syslog-enabled&apos; to</span><br><span class="line">yes,</span><br><span class="line"># and optionally update the other syslog parameters to suit your</span><br><span class="line">needs.</span><br><span class="line"># syslog-enabled no</span><br><span class="line"></span><br><span class="line"># Specify the syslog identity.</span><br><span class="line"># syslog-ident redis</span><br><span class="line"></span><br><span class="line"># Specify the syslog facility.  Must be USER or between LOCAL0-LOCAL7.</span><br><span class="line">#</span><br><span class="line">syslog-facility local0</span><br><span class="line"></span><br><span class="line"># 可用数据库数</span><br><span class="line"># 默认值为16，默认数据库为0，数据库范围在0-（database-1）之间</span><br><span class="line">databases 16</span><br><span class="line"></span><br><span class="line">################################ 快照  </span><br><span class="line">#################################</span><br><span class="line">#</span><br><span class="line"># 保存数据到磁盘，格式如下:</span><br><span class="line">#</span><br><span class="line">#   save</span><br><span class="line">&lt;seconds&gt; &lt;changes&gt;</span><br><span class="line">#</span><br><span class="line">#   </span><br><span class="line">指出在多长时间内，有多少次更新操作，就将数据同步到数据文件rdb。</span><br><span class="line">#   相当于条件触发抓取快照，这个可以多个条件配合</span><br><span class="line">#   </span><br><span class="line">#   </span><br><span class="line">比如默认配置文件中的设置，就设置了三个条件</span><br><span class="line">#</span><br><span class="line">#   save 900 1  900秒内至少有1个key被改变</span><br><span class="line">#   save 300</span><br><span class="line">10  300秒内至少有300个key被改变</span><br><span class="line">#   save 60 10000  60秒内至少有10000个key被改变</span><br><span class="line"></span><br><span class="line">save 900 1</span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br><span class="line"></span><br><span class="line"># 存储至本地数据库时（持久化到rdb文件）是否压缩数据，默认为yes</span><br><span class="line">rdbcompression yes</span><br><span class="line"></span><br><span class="line"># 本地持久化数据库文件名，默认值为dump.rdb</span><br><span class="line">dbfilename dump.rdb</span><br><span class="line"></span><br><span class="line"># 工作目录</span><br><span class="line">#</span><br><span class="line"># 数据库镜像备份的文件放置的路径。</span><br><span class="line">#</span><br><span class="line">这里的路径跟文件名要分开配置是因为redis在进行备份时，先会将当前数据库的状态写入到一个临时文件中，等备份完成时，</span><br><span class="line">#</span><br><span class="line">再把该该临时文件替换为上面所指定的文件，而这里的临时文件和上面所配置的备份文件都会放在这个指定的路径当中。</span><br><span class="line">#</span><br><span class="line">#</span><br><span class="line">AOF文件也会存放在这个目录下面</span><br><span class="line">#</span><br><span class="line"># 注意这里必须制定一个目录而不是文件</span><br><span class="line">dir ./</span><br><span class="line"></span><br><span class="line">################################# 复制</span><br><span class="line">#################################</span><br><span class="line"></span><br><span class="line"># 主从复制. 设置该数据库为其他数据库的从数据库.</span><br><span class="line">#</span><br><span class="line">设置当本机为slav服务时，设置master服务的IP地址及端口，在Redis启动时，它会自动从master进行数据同步</span><br><span class="line">#</span><br><span class="line"># slaveof</span><br><span class="line">&lt;masterip&gt; &lt;masterport&gt;</span><br><span class="line"></span><br><span class="line"># 当master服务设置了密码保护时(用requirepass制定的密码)</span><br><span class="line"># slav服务连接master的密码</span><br><span class="line">#</span><br><span class="line">#</span><br><span class="line">masterauth &lt;master-password&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 当从库同主机失去连接或者复制正在进行，从机库有两种运行方式：</span><br><span class="line">#</span><br><span class="line"># 1)</span><br><span class="line">如果slave-serve-stale-data设置为yes(默认设置)，从库会继续相应客户端的请求</span><br><span class="line">#</span><br><span class="line"># 2)</span><br><span class="line">如果slave-serve-stale-data是指为no，出去INFO和SLAVOF命令之外的任何请求都会返回一个</span><br><span class="line">#    错误&quot;SYNC with</span><br><span class="line">master in progress&quot;</span><br><span class="line">#</span><br><span class="line">slave-serve-stale-data yes</span><br><span class="line"></span><br><span class="line"># 从库会按照一个时间间隔向主库发送PINGs.可以通过repl-ping-slave-period设置这个时间间隔，默认是10秒</span><br><span class="line">#</span><br><span class="line">#</span><br><span class="line">repl-ping-slave-period 10</span><br><span class="line"></span><br><span class="line"># repl-timeout 设置主库批量数据传输时间或者ping回复时间间隔，默认值是60秒</span><br><span class="line">#</span><br><span class="line">一定要确保repl-timeout大于repl-ping-slave-period</span><br><span class="line"># repl-timeout 60</span><br><span class="line"></span><br><span class="line">################################## 安全</span><br><span class="line">###################################</span><br><span class="line"></span><br><span class="line"># 设置客户端连接后进行任何其他指定前需要使用的密码。</span><br><span class="line">#</span><br><span class="line">警告：因为redis速度相当快，所以在一台比较好的服务器下，一个外部的用户可以在一秒钟进行150K次的密码尝试，这意味着你需要指定非常非常强大的密码来防止暴力破解</span><br><span class="line">#</span><br><span class="line">#</span><br><span class="line">requirepass foobared</span><br><span class="line"></span><br><span class="line"># 命令重命名.</span><br><span class="line">#</span><br><span class="line"># 在一个共享环境下可以重命名相对危险的命令。比如把CONFIG重名为一个不容易猜测的字符。</span><br><span class="line">#</span><br><span class="line">#</span><br><span class="line">举例:</span><br><span class="line">#</span><br><span class="line"># rename-command CONFIG</span><br><span class="line">b840fc02d524045429941cc15f59e41cb7be6c52</span><br><span class="line">#</span><br><span class="line">#</span><br><span class="line">如果想删除一个命令，直接把它重命名为一个空字符&quot;&quot;即可，如下：</span><br><span class="line">#</span><br><span class="line"># rename-command CONFIG &quot;&quot;</span><br><span class="line"></span><br><span class="line">################################### 约束</span><br><span class="line">####################################</span><br><span class="line"></span><br><span class="line"># 设置同一时间最大客户端连接数，默认无限制，Redis可以同时打开的客户端连接数为Redis进程可以打开的最大文件描述符数，</span><br><span class="line"># 如果设置</span><br><span class="line">maxclients 0，表示不作限制。</span><br><span class="line"># 当客户端连接数到达限制时，Redis会关闭新的连接并向客户端返回max number of clients</span><br><span class="line">reached错误信息</span><br><span class="line">#</span><br><span class="line"># maxclients 128</span><br><span class="line"></span><br><span class="line"># 指定Redis最大内存限制，Redis在启动时会把数据加载到内存中，达到最大内存后，Redis会先尝试清除已到期或即将到期的Key</span><br><span class="line">#</span><br><span class="line">Redis同时也会移除空的list对象</span><br><span class="line">#</span><br><span class="line">#</span><br><span class="line">当此方法处理后，仍然到达最大内存设置，将无法再进行写入操作，但仍然可以进行读取操作</span><br><span class="line">#</span><br><span class="line">#</span><br><span class="line">注意：Redis新的vm机制，会把Key存放内存，Value会存放在swap区</span><br><span class="line">#</span><br><span class="line">#</span><br><span class="line">maxmemory的设置比较适合于把redis当作于类似memcached的缓存来使用，而不适合当做一个真实的DB。</span><br><span class="line">#</span><br><span class="line">当把Redis当做一个真实的数据库使用的时候，内存使用将是一个很大的开销</span><br><span class="line"># maxmemory &lt;bytes&gt;</span><br><span class="line"></span><br><span class="line"># 当内存达到最大值的时候Redis会选择删除哪些数据？有五种方式可供选择</span><br><span class="line">#</span><br><span class="line"># volatile-lru -&gt;</span><br><span class="line">利用LRU算法移除设置过过期时间的key (LRU:最近使用 Least Recently Used )</span><br><span class="line"># allkeys-lru -&gt;</span><br><span class="line">利用LRU算法移除任何key</span><br><span class="line"># volatile-random -&gt; 移除设置过过期时间的随机key</span><br><span class="line">#</span><br><span class="line">allkeys-&gt;random -&gt; remove a random key, any key</span><br><span class="line"># volatile-ttl -&gt;</span><br><span class="line">移除即将过期的key(minor TTL)</span><br><span class="line"># noeviction -&gt; 不移除任何可以，只是返回一个写错误</span><br><span class="line">#</span><br><span class="line">#</span><br><span class="line">注意：对于上面的策略，如果没有合适的key可以移除，当写的时候Redis会返回一个错误</span><br><span class="line">#</span><br><span class="line">#       写命令包括: set setnx</span><br><span class="line">setex append</span><br><span class="line">#       incr decr rpush lpush rpushx lpushx linsert lset</span><br><span class="line">rpoplpush sadd</span><br><span class="line">#       sinter sinterstore sunion sunionstore sdiff sdiffstore</span><br><span class="line">zadd zincrby</span><br><span class="line">#       zunionstore zinterstore hset hsetnx hmset hincrby incrby</span><br><span class="line">decrby</span><br><span class="line">#       getset mset msetnx exec sort</span><br><span class="line">#</span><br><span class="line"># 默认是:</span><br><span class="line">#</span><br><span class="line">#</span><br><span class="line">maxmemory-policy volatile-lru</span><br><span class="line"></span><br><span class="line"># LRU 和 minimal TTL 算法都不是精准的算法，但是相对精确的算法(为了节省内存)，随意你可以选择样本大小进行检测。</span><br><span class="line">#</span><br><span class="line">Redis默认的灰选择3个样本进行检测，你可以通过maxmemory-samples进行设置</span><br><span class="line">#</span><br><span class="line"># maxmemory-samples</span><br><span class="line">3</span><br><span class="line"></span><br><span class="line">############################## AOF ###############################</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#</span><br><span class="line">默认情况下，redis会在后台异步的把数据库镜像备份到磁盘，但是该备份是非常耗时的，而且备份也不能很频繁，如果发生诸如拉闸限电、拔插头等状况，那么将造成比较大范围的数据丢失。</span><br><span class="line">#</span><br><span class="line">所以redis提供了另外一种更加高效的数据库备份及灾难恢复方式。</span><br><span class="line"># 开启append</span><br><span class="line">only模式之后，redis会把所接收到的每一次写操作请求都追加到appendonly.aof文件中，当redis重新启动时，会从该文件恢复出之前的状态。</span><br><span class="line">#</span><br><span class="line">但是这样会造成appendonly.aof文件过大，所以redis还支持了BGREWRITEAOF指令，对appendonly.aof 进行重新整理。</span><br><span class="line">#</span><br><span class="line">你可以同时开启asynchronous dumps 和 AOF</span><br><span class="line"></span><br><span class="line">appendonly no</span><br><span class="line"></span><br><span class="line"># AOF文件名称 (默认: &quot;appendonly.aof&quot;)</span><br><span class="line"># appendfilename appendonly.aof</span><br><span class="line"></span><br><span class="line"># Redis支持三种同步AOF文件的策略:</span><br><span class="line">#</span><br><span class="line"># no: 不进行同步，系统去操作 . Faster.</span><br><span class="line"># always:</span><br><span class="line">always表示每次有写操作都进行同步. Slow, Safest.</span><br><span class="line"># everysec: 表示对写操作进行累积，每秒同步一次.</span><br><span class="line">Compromise.</span><br><span class="line">#</span><br><span class="line"># 默认是&quot;everysec&quot;，按照速度和安全折中这是最好的。</span><br><span class="line">#</span><br><span class="line">如果想让Redis能更高效的运行，你也可以设置为&quot;no&quot;，让操作系统决定什么时候去执行</span><br><span class="line">#</span><br><span class="line">或者相反想让数据更安全你也可以设置为&quot;always&quot;</span><br><span class="line">#</span><br><span class="line"># 如果不确定就用 &quot;everysec&quot;.</span><br><span class="line"></span><br><span class="line"># appendfsync always</span><br><span class="line">appendfsync everysec</span><br><span class="line"># appendfsync no</span><br><span class="line"></span><br><span class="line"># AOF策略设置为always或者everysec时，后台处理进程(后台保存或者AOF日志重写)会执行大量的I/O操作</span><br><span class="line">#</span><br><span class="line">在某些Linux配置中会阻止过长的fsync()请求。注意现在没有任何修复，即使fsync在另外一个线程进行处理</span><br><span class="line">#</span><br><span class="line">#</span><br><span class="line">为了减缓这个问题，可以设置下面这个参数no-appendfsync-on-rewrite</span><br><span class="line">#</span><br><span class="line"># This means that while</span><br><span class="line">another child is saving the durability of Redis is</span><br><span class="line"># the same as &quot;appendfsync</span><br><span class="line">none&quot;, that in pratical terms means that it is</span><br><span class="line"># possible to lost up to 30</span><br><span class="line">seconds of log in the worst scenario (with the</span><br><span class="line"># default Linux</span><br><span class="line">settings).</span><br><span class="line">#</span><br><span class="line"># If you have latency problems turn this to &quot;yes&quot;. Otherwise</span><br><span class="line">leave it as</span><br><span class="line"># &quot;no&quot; that is the safest pick from the point of view of</span><br><span class="line">durability.</span><br><span class="line">no-appendfsync-on-rewrite no</span><br><span class="line"></span><br><span class="line"># Automatic rewrite of the append only file.</span><br><span class="line"># AOF 自动重写</span><br><span class="line">#</span><br><span class="line">当AOF文件增长到一定大小的时候Redis能够调用 BGREWRITEAOF 对日志文件进行重写</span><br><span class="line">#</span><br><span class="line">#</span><br><span class="line">它是这样工作的：Redis会记住上次进行些日志后文件的大小(如果从开机以来还没进行过重写，那日子大小在开机的时候确定)</span><br><span class="line">#</span><br><span class="line">#</span><br><span class="line">基础大小会同现在的大小进行比较。如果现在的大小比基础大小大制定的百分比，重写功能将启动</span><br><span class="line">#</span><br><span class="line">同时需要指定一个最小大小用于AOF重写，这个用于阻止即使文件很小但是增长幅度很大也去重写AOF文件的情况</span><br><span class="line"># 设置 percentage</span><br><span class="line">为0就关闭这个特性</span><br><span class="line"></span><br><span class="line">auto-aof-rewrite-percentage 100</span><br><span class="line">auto-aof-rewrite-min-size 64mb</span><br><span class="line"></span><br><span class="line">################################## SLOW LOG</span><br><span class="line">###################################</span><br><span class="line"></span><br><span class="line"># Redis Slow Log 记录超过特定执行时间的命令。执行时间不包括I/O计算比如连接客户端，返回结果等，只是命令执行时间</span><br><span class="line">#</span><br><span class="line">#</span><br><span class="line">可以通过两个参数设置slow log：一个是告诉Redis执行超过多少时间被记录的参数slowlog-log-slower-than(微妙)，</span><br><span class="line">#</span><br><span class="line">另一个是slow log 的长度。当一个新命令被记录的时候最早的命令将被从队列中移除</span><br><span class="line"></span><br><span class="line"># 下面的时间以微妙微单位，因此1000000代表一分钟。</span><br><span class="line">#</span><br><span class="line">注意制定一个负数将关闭慢日志，而设置为0将强制每个命令都会记录</span><br><span class="line">slowlog-log-slower-than 10000</span><br><span class="line"></span><br><span class="line"># 对日志长度没有限制，只是要注意它会消耗内存</span><br><span class="line"># 可以通过 SLOWLOG RESET</span><br><span class="line">回收被慢日志消耗的内存</span><br><span class="line">slowlog-max-len 1024</span><br><span class="line"></span><br><span class="line">################################ VM ###############################</span><br><span class="line"></span><br><span class="line">### WARNING! Virtual Memory is deprecated in Redis 2.4</span><br><span class="line">### The use of</span><br><span class="line">Virtual Memory is strongly discouraged.</span><br><span class="line"></span><br><span class="line"># Virtual Memory allows Redis to work with datasets bigger than the</span><br><span class="line">actual</span><br><span class="line"># amount of RAM needed to hold the whole dataset in memory.</span><br><span class="line"># In</span><br><span class="line">order to do so very used keys are taken in memory while the other keys</span><br><span class="line"># are</span><br><span class="line">swapped into a swap file, similarly to what operating systems do</span><br><span class="line"># with</span><br><span class="line">memory pages.</span><br><span class="line">#</span><br><span class="line"># To enable VM just set &apos;vm-enabled&apos; to yes, and set the</span><br><span class="line">following three</span><br><span class="line"># VM parameters accordingly to your needs.</span><br><span class="line"></span><br><span class="line">vm-enabled no</span><br><span class="line"># vm-enabled yes</span><br><span class="line"></span><br><span class="line"># This is the path of the Redis swap file. As you can guess, swap</span><br><span class="line">files</span><br><span class="line"># can&apos;t be shared by different Redis instances, so make sure to use a</span><br><span class="line">swap</span><br><span class="line"># file for every redis process you are running. Redis will complain if</span><br><span class="line">the</span><br><span class="line"># swap file is already in use.</span><br><span class="line">#</span><br><span class="line"># The best kind of storage for the</span><br><span class="line">Redis swap file (that&apos;s accessed at random)</span><br><span class="line"># is a Solid State Disk</span><br><span class="line">(SSD).</span><br><span class="line">#</span><br><span class="line"># *** WARNING *** if you are using a shared hosting the default</span><br><span class="line">of putting</span><br><span class="line"># the swap file under /tmp is not secure. Create a dir with access</span><br><span class="line">granted</span><br><span class="line"># only to Redis user and configure Redis to create the swap file</span><br><span class="line">there.</span><br><span class="line">vm-swap-file /tmp/redis.swap</span><br><span class="line"></span><br><span class="line"># vm-max-memory configures the VM to use at max the specified amount</span><br><span class="line">of</span><br><span class="line"># RAM. Everything that deos not fit will be swapped on disk *if* possible,</span><br><span class="line">that</span><br><span class="line"># is, if there is still enough contiguous space in the swap</span><br><span class="line">file.</span><br><span class="line">#</span><br><span class="line"># With vm-max-memory 0 the system will swap everything it can. Not</span><br><span class="line">a good</span><br><span class="line"># default, just specify the max amount of RAM you can in bytes, but</span><br><span class="line">it&apos;s</span><br><span class="line"># better to leave some margin. For instance specify an amount of</span><br><span class="line">RAM</span><br><span class="line"># that&apos;s more or less between 60 and 80% of your free</span><br><span class="line">RAM.</span><br><span class="line">vm-max-memory 0</span><br><span class="line"></span><br><span class="line"># Redis swap files is split into pages. An object can be saved using</span><br><span class="line">multiple</span><br><span class="line"># contiguous pages, but pages can&apos;t be shared between different</span><br><span class="line">objects.</span><br><span class="line"># So if your page is too big, small objects swapped out on disk will</span><br><span class="line">waste</span><br><span class="line"># a lot of space. If you page is too small, there is less space in the</span><br><span class="line">swap</span><br><span class="line"># file (assuming you configured the same number of total swap file</span><br><span class="line">pages).</span><br><span class="line">#</span><br><span class="line"># If you use a lot of small objects, use a page size of 64 or 32</span><br><span class="line">bytes.</span><br><span class="line"># If you use a lot of big objects, use a bigger page size.</span><br><span class="line"># If</span><br><span class="line">unsure, use the default :)</span><br><span class="line">vm-page-size 32</span><br><span class="line"></span><br><span class="line"># Number of total memory pages in the swap file.</span><br><span class="line"># Given that the page</span><br><span class="line">table (a bitmap of free/used pages) is taken in memory,</span><br><span class="line"># every 8 pages on</span><br><span class="line">disk will consume 1 byte of RAM.</span><br><span class="line">#</span><br><span class="line"># The total swap size is vm-page-size *</span><br><span class="line">vm-pages</span><br><span class="line">#</span><br><span class="line"># With the default of 32-bytes memory pages and 134217728 pages</span><br><span class="line">Redis will</span><br><span class="line"># use a 4 GB swap file, that will use 16 MB of RAM for the page</span><br><span class="line">table.</span><br><span class="line">#</span><br><span class="line"># It&apos;s better to use the smallest acceptable value for your</span><br><span class="line">application,</span><br><span class="line"># but the default is large in order to work in most</span><br><span class="line">conditions.</span><br><span class="line">vm-pages 134217728</span><br><span class="line"></span><br><span class="line"># Max number of VM I/O threads running at the same time.</span><br><span class="line"># This threads</span><br><span class="line">are used to read/write data from/to swap file, since they</span><br><span class="line"># also encode and</span><br><span class="line">decode objects from disk to memory or the reverse, a bigger</span><br><span class="line"># number of</span><br><span class="line">threads can help with big objects even if they can&apos;t help with</span><br><span class="line"># I/O itself</span><br><span class="line">as the physical device may not be able to couple with many</span><br><span class="line"># reads/writes</span><br><span class="line">operations at the same time.</span><br><span class="line">#</span><br><span class="line"># The special value of 0 turn off threaded</span><br><span class="line">I/O and enables the blocking</span><br><span class="line"># Virtual Memory</span><br><span class="line">implementation.</span><br><span class="line">vm-max-threads 4</span><br><span class="line"></span><br><span class="line">############################### ADVANCED CONFIG</span><br><span class="line">###############################</span><br><span class="line"></span><br><span class="line"># 当hash中包含超过指定元素个数并且最大的元素没有超过临界时，</span><br><span class="line">#</span><br><span class="line">hash将以一种特殊的编码方式（大大减少内存使用）来存储，这里可以设置这两个临界值</span><br><span class="line"># Redis</span><br><span class="line">Hash对应Value内部实际就是一个HashMap，实际这里会有2种不同实现，</span><br><span class="line">#</span><br><span class="line">这个Hash的成员比较少时Redis为了节省内存会采用类似一维数组的方式来紧凑存储，而不会采用真正的HashMap结构，对应的value</span><br><span class="line">redisObject的encoding为zipmap,</span><br><span class="line">#</span><br><span class="line">当成员数量增大时会自动转成真正的HashMap,此时encoding为ht。</span><br><span class="line">hash-max-zipmap-entries</span><br><span class="line">512</span><br><span class="line">hash-max-zipmap-value 64</span><br><span class="line"></span><br><span class="line"># list数据类型多少节点以下会采用去指针的紧凑存储格式。</span><br><span class="line">#</span><br><span class="line">list数据类型节点值大小小于多少字节会采用紧凑存储格式。</span><br><span class="line">list-max-ziplist-entries</span><br><span class="line">512</span><br><span class="line">list-max-ziplist-value 64</span><br><span class="line"></span><br><span class="line"># set数据类型内部数据如果全部是数值型，且包含多少节点以下会采用紧凑格式存储。</span><br><span class="line">set-max-intset-entries</span><br><span class="line">512</span><br><span class="line"></span><br><span class="line"># zsort数据类型多少节点以下会采用去指针的紧凑存储格式。</span><br><span class="line">#</span><br><span class="line">zsort数据类型节点值大小小于多少字节会采用紧凑存储格式。</span><br><span class="line">zset-max-ziplist-entries</span><br><span class="line">128</span><br><span class="line">zset-max-ziplist-value 64</span><br><span class="line"></span><br><span class="line"># Redis将在每100毫秒时使用1毫秒的CPU时间来对redis的hash表进行重新hash，可以降低内存的使用</span><br><span class="line">#</span><br><span class="line">#</span><br><span class="line">当你的使用场景中，有非常严格的实时性需要，不能够接受Redis时不时的对请求有2毫秒的延迟的话，把这项配置为no。</span><br><span class="line">#</span><br><span class="line">#</span><br><span class="line">如果没有这么严格的实时性要求，可以设置为yes，以便能够尽可能快的释放内存</span><br><span class="line">activerehashing yes</span><br><span class="line"></span><br><span class="line">################################## INCLUDES</span><br><span class="line">###################################</span><br><span class="line"></span><br><span class="line"># 指定包含其它的配置文件，可以在同一主机上多个Redis实例之间使用同一份配置文件，而同时各个实例又拥有自己的特定配置文件</span><br><span class="line">#</span><br><span class="line">include /path/to/local.conf</span><br><span class="line"># include /path/to/other.conf</span><br></pre></td></tr></table></figure>

      
    </div>
    
    
    

    

    

    

<div>
  
    <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div>
    
</div>

  
</div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/redis/" rel="tag"># redis</a>
          
            <a href="/tags/缓存/" rel="tag"># 缓存</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/11/11/关于并发的一点思考/" rel="next" title="关于并发的一点思考">
                <i class="fa fa-chevron-left"></i> 关于并发的一点思考
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/uploads/avatar.png" alt="xiemao">
            
              <p class="site-author-name" itemprop="name">xiemao</p>
              <p class="site-description motion-element" itemprop="description">还是佛系点好</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#关于redis的一点总结"><span class="nav-number">1.</span> <span class="nav-text">关于redis的一点总结</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#引言"><span class="nav-number">1.1.</span> <span class="nav-text">引言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#缓存"><span class="nav-number">1.2.</span> <span class="nav-text">缓存</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#redis特点"><span class="nav-number">1.3.</span> <span class="nav-text">redis特点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#持久化操作：rdb和aof"><span class="nav-number">1.4.</span> <span class="nav-text">持久化操作：rdb和aof</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#版本比较"><span class="nav-number">1.5.</span> <span class="nav-text">版本比较</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#架构演进图"><span class="nav-number">1.6.</span> <span class="nav-text">架构演进图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#单实例安装"><span class="nav-number">1.7.</span> <span class="nav-text">单实例安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#哨兵模式的安装"><span class="nav-number">1.8.</span> <span class="nav-text">哨兵模式的安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis-3-0-集群搭建"><span class="nav-number">1.9.</span> <span class="nav-text">Redis 3.0 集群搭建</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#I-O-多路复用"><span class="nav-number">1.10.</span> <span class="nav-text">I/O 多路复用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#事务"><span class="nav-number">1.11.</span> <span class="nav-text">事务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#缓存淘汰策略："><span class="nav-number">1.12.</span> <span class="nav-text">缓存淘汰策略：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#实际应用场景，自己的一点体会："><span class="nav-number">1.13.</span> <span class="nav-text">实际应用场景，自己的一点体会：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置文件参考："><span class="nav-number">1.14.</span> <span class="nav-text">配置文件参考：</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">xiemao</span>

  
</div>






  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = '';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'O3OU6MOvvlj9sHxrRyuL4XYD-gzGzoHsz',
        appKey: 'PB4lfAXOAOXoVxdTOmeP8KhV',
        placeholder: 'Just go go',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
